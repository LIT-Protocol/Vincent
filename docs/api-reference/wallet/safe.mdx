---
title: 'Safe Integration'
---

This guide demonstrates how to integrate Vincent with Safe multi-sig smart accounts using the Aave ability as an example. You'll learn how to set up account delegation, generate UserOperations, validate and sign them with Vincent abilities using EIP-712, and broadcast transactions through Pimlico's bundler.

<CardGroup cols={2}>
  <Card title="Source Repository" icon="github" href="https://github.com/LIT-Protocol/vincent-smart-account-signer" color="#FF4205">
    View the complete example repository
  </Card>
  <Card title="safeSmartAccountIntegration.ts" icon="code" href="https://github.com/LIT-Protocol/vincent-smart-account-signer/blob/main/src/safeSmartAccountIntegration.ts" color="#FF4205">
    View the complete implementation file
  </Card>
</CardGroup>

## Prerequisites

**Vincent Setup**: Follow [Creating an App](/app/creating-an-app) to obtain your Vincent App ID, Delegatee Private Key, and PKP ETH Address.

Set the following environment variables:

- **PIMLICO_RPC_URL**: Bundler and paymaster endpoint from your [Pimlico](https://www.pimlico.io/) project
- **ALCHEMY_RPC_URL**: Endpoint for transaction simulation from [Alchemy](https://www.alchemy.com/)
- **VINCENT_APP_ID**: Your Vincent application identifier
- **DELEGATEE_PRIVATE_KEY**: Private key for Vincent ability delegation
- **PKP_ETH_ADDRESS**: Your Programmable Key Pair Ethereum address

## Complete Integration Flow

### Step 1: Setup Account and Delegation

```typescript
import { setupSafeSmartAccountAndDelegation } from './utils/setupSafeSmartAccountAndDelegation';

const { safeAccount, pkpEthAddress } =
  await setupSafeSmartAccountAndDelegation();
```

**What this does:**
1. Sets up Vincent PKP delegation
2. Creates Safe account (v1.4.1) with owner
3. Adds Vincent PKP as additional owner with threshold 1

**Returns:**
- `safeAccount`: The Safe smart account
- `pkpEthAddress`: Vincent PKP address

<AccordionGroup>
  <Accordion title="View setupSafeSmartAccountAndDelegation.ts">
    ```typescript
    export async function setupSafeSmartAccountAndDelegation() {
      // Get pkp to delegate signatures
      const pkpEthAddress = await setupVincentDelegation({
        ownerAccount,
        vincentAppId,
      });

      // Set up Safe account with PKP as owner
      const { safeAccount, safeClient } = await setupSafeAccount({
        ownerAccount,
        permittedAddress: pkpEthAddress,
      });

      return {
        safeAccount,
        safeClient,
        pkpEthAddress,
      };
    }
    ```
  </Accordion>

  <Accordion title="View setupSafeAccount.ts">
    ```typescript
    export async function setupSafeAccount({
      ownerAccount,
      permittedAddress,
    }: SetupSafeAccountParams) {
      // Create Safe account
      const safeAccount = await toSafeSmartAccount({
        entryPoint,
        client: publicClient,
        owners: [ownerAccount],
        version: safeVersion,
      });

      const safeClient = createSmartAccountClient({
        account: safeAccount,
        chain,
        bundlerTransport: pimlicoTransport,
        paymaster: pimlicoClient,
        userOperation: {
          estimateFeesPerGas: async () => {
            return (await pimlicoClient.getUserOperationGasPrice()).fast;
          },
        },
      });

      // Add Vincent PKP as owner with threshold 1
      const addOwnerCallData = await encodeAddOwnerWithThresholdCall(
        permittedAddress,
        1n
      );

      const txHash = await safeClient.sendTransaction({
        to: safeAccount.address,
        value: 0n,
        data: addOwnerCallData,
      });

      await publicClient.waitForTransactionReceipt({
        confirmations: 2,
        hash: txHash,
      });

      return { safeAccount, safeClient };
    }
    ```
  </Accordion>
</AccordionGroup>

### Step 2: Generate Transactions

```typescript
import { generateTransactions } from './utils/generateTransactions';

const transactions = await generateTransactions({
  accountAddress: safeAccount.address,
});
```

**What this does:**
Generates Aave transactions (approve, supply, withdraw) based on account state.

### Step 3: Convert to UserOperation

```typescript
import { transactionsToSafeUserOp } from './utils/transactionsToSafeUserOp';

const aaveUserOp = await transactionsToSafeUserOp({
  transactions,
  safeAddress: safeAccount.address,
  permittedAddress: pkpEthAddress,
});
```

**What this does:**
Creates a Safe-compatible UserOperation using Pimlico bundler.

<AccordionGroup>
  <Accordion title="View transactionsToSafeUserOp.ts">
    ```typescript
    export async function transactionsToSafeUserOp({
      permittedAddress,
      safeAddress,
      transactions,
    }: TransactionsToSafeUserOpParams) {
      const safeAccount = await toSafeSmartAccount({
        address: safeAddress,
        client: publicClient,
        entryPoint,
        owners: [addressToEmptyAccount(permittedAddress)],
        version: safeVersion,
      });

      const safeSmartAccountClient = createSmartAccountClient({
        account: safeAccount,
        chain,
        bundlerTransport: pimlicoTransport,
        paymaster: pimlicoClient,
        userOperation: {
          estimateFeesPerGas: async () => {
            return (await pimlicoClient.getUserOperationGasPrice()).fast;
          },
        },
      });

      const aaveUserOp = await safeSmartAccountClient.prepareUserOperation({
        calls: transactions.map((tx) => ({
          to: tx.to,
          data: tx.data,
          value: tx.value,
        })),
      });

      return aaveUserOp;
    }
    ```
  </Accordion>
</AccordionGroup>

### Step 4: Validate with Vincent (Safe-specific params)

```typescript
import { toVincentUserOp, safeEip712Params } from '@lit-protocol/vincent-ability-aave-smart-account';

const validAfter = 0;  // 0 for unlimited
const validUntil = 0;  // 0 for unlimited

const vincentAbilityParams = {
  validAfter,
  validUntil,
  alchemyRpcUrl: alchemyRpc,
  eip712Params: safeEip712Params,
  entryPointAddress: entryPoint.address,
  safe4337ModuleAddress: '0x75cf11467937ce3F2f357CE24ffc3DBF8fD5c226',
  userOp: toVincentUserOp(aaveUserOp),
};

const vincentDelegationContext = {
  delegatorPkpEthAddress: pkpEthAddress,
};

const precheckResult = await abilityClient.precheck(
  vincentAbilityParams,
  vincentDelegationContext
);

if (!precheckResult.success) {
  throw new Error(`Precheck failed: ${JSON.stringify(precheckResult)}`);
}
```

**Safe-specific parameters:**
- `validAfter`: Signature validity start timestamp (0 = unlimited)
- `validUntil`: Signature validity end timestamp (0 = unlimited)
- `eip712Params`: EIP-712 signing configuration (use `safeEip712Params` from SDK)
- `safe4337ModuleAddress`: Safe 4337 module address

### Step 5: Execute and Sign

```typescript
const executeResult = await abilityClient.execute(
  vincentAbilityParams,
  vincentDelegationContext
);

if (!executeResult.success) {
  throw new Error(`Execute failed: ${JSON.stringify(executeResult)}`);
}
```

**What this does:**
Signs using EIP-712 instead of standard UserOperation hash signing.

### Step 6: Format Signature

```typescript
import { concat, toHex, Hex } from 'viem';

const signedAaveUserOp = {
  ...aaveUserOp,
  // Safe signatures: [validAfter (6 bytes)][validUntil (6 bytes)][ECDSA sig]
  signature: concat([
    toHex(validAfter, { size: 6 }),
    toHex(validUntil, { size: 6 }),
    executeResult.result.signature as Hex
  ]),
};
```

**Critical:** Safe signatures require validity timestamps prepended to the signature.

**Format:**
```
[validAfter (6 bytes)][validUntil (6 bytes)][ECDSA signature]
```

### Step 7: Broadcast

```typescript
import { sendPermittedSafeUserOperation } from './utils/sendPermittedSafeUserOperation';

await sendPermittedSafeUserOperation({
  signedUserOp: signedAaveUserOp,
});
```

**What this does:**
Submits signed UserOperation to Pimlico bundler and waits for receipt.

<AccordionGroup>
  <Accordion title="View sendPermittedSafeUserOperation.ts">
    ```typescript
    export async function sendPermittedSafeUserOperation({
      signedUserOp,
    }: SendPermittedSafeUserOperationParams) {
      const userOpHash = await smartAccountClient.sendUserOperation(signedUserOp);

      const receipt = await smartAccountClient.waitForUserOperationReceipt({
        hash: userOpHash,
      });

      console.log('UserOp hash:', userOpHash);
      console.log('Transaction hash:', receipt.receipt.transactionHash);
    }
    ```
  </Accordion>
</AccordionGroup>

### Step 8: Cleanup

```typescript
import { disconnectVincentAbilityClients } from '@lit-protocol/vincent-app-sdk/abilityClient';

await disconnectVincentAbilityClients();
```

## Complete Example

<Card title="safeSmartAccountIntegration.ts" icon="github" href="https://github.com/LIT-Protocol/vincent-smart-account-signer/blob/main/src/safeSmartAccountIntegration.ts" color="#FF4205">
  View the complete implementation on GitHub
</Card>
